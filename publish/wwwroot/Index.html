<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">üìã Task Manager</h2>

    <!-- Error message -->
    <div id="error-message" class="alert alert-danger d-none"></div>

    <!-- Add Task Form -->
    <form id="task-form">
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
    <input type="text" id="title" class="form-control" required />
  </div>
  <div class="mb-3">
    <label for="subject" class="form-label">Subject</label>
    <input type="text" id="subject" class="form-control" required />
  </div>
  <div class="mb-3">
    <label for="notification" class="form-label">Notification</label>
    <select id="notification" class="form-select">
      <option value="true">On</option>
      <option value="false">Off</option>
    </select>
  </div>
  <button type="submit" class="btn btn-primary">Add Task</button>
</form>


    <!-- Task Table -->
    <table class="table table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th>TITLE</th>
          <th>SUBJECT</th>
          <th>IS DONE</th>
          <!-- <th>CREATED BY</th> -->
          <th>CREATED AT</th>
          <th>START TIME</th>
          <th>NOTIFICATION</th>
          <th>ACTIONS</th>
        </tr>
      </thead>
      <tbody id="task-table-body"></tbody>
    </table>
  </div>

  <script>
   const API_BASE = window.API_BASE || ''; // change to your backend URL

    function getAuthHeaders() {
      const token = localStorage.getItem("jwtToken");
      return {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      };
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${API_BASE}/api/Tasks`, { headers: getAuthHeaders() });
        if (!res.ok) throw new Error("Failed to fetch tasks");
        const tasks = await res.json();

        const tbody = document.getElementById("task-table-body");
        tbody.innerHTML = "";
//Removed             <td>${task.createdby}</td>
        tasks.forEach(task => {
          const row = `
            <tr>
              <td>${task.title}</td>
              <td>${task.subject}</td>
              <td>${task.isdone ? "‚úÖ" : "‚ùå"}</td>
              <td>${new Date(task.createdat).toLocaleString()}</td>
              <td>${new Date(task.starttime).toLocaleString()}</td>
              <td>${task.notificationon ? "üîî ON" : "üîï OFF"}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="toggleDone(${task.taskid}, ${task.isdone})">‚úî Toggle</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.taskid})">üóë Delete</button>
              </td>
            </tr>
          `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      } catch (err) {
        showError(err.message);
      }
    }

async function addTask(e) {
  e.preventDefault();
const task = {
  title: document.getElementById("title").value,
  subject: document.getElementById("subject").value,
  isdone: false,
  notificationon: document.getElementById("notification").value === "true"
};

  console.log("üì§ Sending task:", task);  // Debug line

  try {
    const res = await fetch(`${API_BASE}/api/Tasks`, {
      method: "POST",
      headers: getAuthHeaders(),
      body: JSON.stringify(task)
    });

    console.log("üì• Server response:", res.status);

    if (!res.ok) {
      const errMsg = await res.text();
      throw new Error(errMsg || "Failed to create task");
    }

    document.getElementById("task-form").reset();
    loadTasks();
  } catch (err) {
    showError(err.message);
  }
}
    async function toggleDone(id, isdone, title, subject, notificationon) {
  try {
    const res = await fetch(`${API_BASE}/api/Tasks/${id}`, {
      method: "PUT",
      headers: getAuthHeaders(),
      body: JSON.stringify({
        taskid: id,
        title: title,
        subject: subject,
        isdone: !isdone,
        notificationon: notificationon
      })
    });

    if (!res.ok && res.status !== 204) {
      const errMsg = await res.text();
      throw new Error(errMsg || "Failed to update task");
    }

    loadTasks();
  } catch (err) {
    showError(err.message);
  }
}


    async function deleteTask(id) {
      try {
        const res = await fetch(`${API_BASE}/api/Tasks/${id}`, {
          method: "DELETE",
          headers: getAuthHeaders()
        });
        if (!res.ok && res.status !== 204) throw new Error("Failed to delete task");
        loadTasks();
      } catch (err) {
        showError(err.message);
      }
    }

    function showError(message) {
      const div = document.getElementById("error-message");
      div.textContent = message;
      div.classList.remove("d-none");
    }

    document.getElementById("task-form").addEventListener("submit", addTask);

    // Run on page load
    loadTasks();
  </script>
</body>
</html>
